<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Kalender-Eintrag erstellen</title>
</head>
<body>
  <h1>Dein Kalender-Ereignis wird erstellt…</h1>
  <p id="status">Einen Moment…</p>

  <script>
    function pad(n) {
      return n.toString().padStart(2, '0');
    }

    function generateICS(text, dateStr, timeStr) {
      const [day, month, year] = dateStr.split('.');
      const [hour, minute] = timeStr !== "unbekannt" ? timeStr.split(':') : ['08', '00'];
      const startDate = new Date(`${year}-${month}-${day}T${hour}:${minute}:00`);

      // Dauer: 1 Stunde
      const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);

      function formatICSDate(date) {
        return date.getUTCFullYear()
          + pad(date.getUTCMonth() + 1)
          + pad(date.getUTCDate())
          + 'T'
          + pad(date.getUTCHours())
          + pad(date.getUTCMinutes())
          + '00Z';
      }

      const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'CALSCALE:GREGORIAN',
        'BEGIN:VEVENT',
        `SUMMARY:${text}`,
        `DESCRIPTION:${text}`,
        `DTSTART:${formatICSDate(startDate)}`,
        `DTEND:${formatICSDate(endDate)}`,
        `DTSTAMP:${formatICSDate(new Date())}`,
        `UID:${Date.now()}@vergissnix`,
        'STATUS:CONFIRMED',
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\r\n');

      return icsContent;
    }

    function downloadICS(content, filename = "erinnerung.ics") {
      const blob = new Blob([content], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    const params = new URLSearchParams(window.location.search);
    const text = params.get("text") || "Erinnerung";
    const date = params.get("date");
    const time = params.get("time") || "08:00";

    if (date) {
      const icsFile = generateICS(text, date, time);
      downloadICS(icsFile);
      document.getElementById("status").textContent = "Kalendereintrag wurde heruntergeladen.";
    } else {
      document.getElementById("status").textContent = "Keine gültigen Daten übergeben.";
    }
  </script>
</body>
</html>
